<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Schlaf- & Lifestyle-Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #fff; color: #000; margin: 20px; }
  h2 { margin-top: 40px; }
  label { display: block; margin-top: 10px; }
  input[type=number], input[type=time], input[type=date], select { width: 80px; }
  button { margin-top: 10px; padding: 5px 10px; margin-right:5px;}
  .chart-container { width: 100%; max-width: 800px; margin-top: 20px; }
  .date-nav { margin-top: 10px; }
</style>
</head>
<body>

<h1>Schlaf- & Lifestyle-Tracker</h1>

<div>
  <label>Datum: <input type="date" id="entryDate"></label>
  
  <label>Aufwachmomente (1-10): <input type="number" id="wakeMoments" min="1" max="10"></label>
  
  <label>Wachheit (1-10): <input type="number" id="alertness" min="1" max="10"></label>
  <label>Energie Schule (1-10): <input type="number" id="energySchool" min="1" max="10"></label>
  <label>Energie Zuhause (1-10): <input type="number" id="energyHome" min="1" max="10"></label>
  
  <label>Sport gemacht: 
    <select id="sport">
      <option value="true">Ja</option>
      <option value="false">Nein</option>
    </select>
  </label>
  
  <label>Handy vor Schlaf (Minuten): <input type="number" id="phoneBeforeSleep" min="0" max="300"></label>
  <label>Letzte Mahlzeit vor Schlaf (Minuten): <input type="number" id="mealBeforeSleep" min="0" max="300"></label>
  <label>Koffein konsumiert: 
    <select id="caffeine">
      <option value="true">Ja</option>
      <option value="false">Nein</option>
    </select>
  </label>
  <label>Alkohol konsumiert: 
    <select id="alcohol">
      <option value="true">Ja</option>
      <option value="false">Nein</option>
    </select>
  </label>
  <label>Stress: 
    <select id="stress">
      <option value="true">Ja</option>
      <option value="false">Nein</option>
    </select>
  </label>
  
  <label>Einschlafzeit: <input type="time" id="sleepTime"></label>
  <label>Aufstehzeit: <input type="time" id="wakeTime"></label>
  
  <label>Kalorien: <input type="number" id="calories" min="0" max="5000"></label>
  <label>Gewicht (kg): <input type="number" id="weight" min="30" max="200" step="0.1"></label>
  
  <button onclick="saveEntry()">Speichern</button>
</div>

<div class="date-nav">
  <button onclick="changeDate(-1)">← Tag zurück</button>
  <button onclick="changeDate(1)">→ Tag vor</button>
</div>

<div class="date-nav">
  <strong>Zeitraum:</strong>
  <button onclick="setTimeFilter(7)">Letzte 7 Tage</button>
  <button onclick="setTimeFilter(30)">Letzte 30 Tage</button>
  <button onclick="setTimeFilter(365)">Letzte 12 Monate</button>
</div>

<h2>Schlaf & Aufwachmomente</h2>
<div class="chart-container">
  <canvas id="sleepChart"></canvas>
</div>

<h2>Energie</h2>
<div class="chart-container">
  <canvas id="energyChart"></canvas>
</div>

<h2>Kalorien & Gewicht</h2>
<div class="chart-container">
  <canvas id="calorieWeightChart"></canvas>
</div>

<h2>Einschlaf- & Aufstehzeit-Abweichung (%)</h2>
<div class="chart-container">
  <canvas id="sleepDeviationChart"></canvas>
</div>

<h2>Lifestyle-Faktoren</h2>
<div class="chart-container">
  <canvas id="lifestyleChart"></canvas>
</div>

<script>
let entries = JSON.parse(localStorage.getItem('sleepData') || '[]');
let currentDate = new Date().toISOString().split('T')[0];
let filterDays = 365; // Standard: letztes Jahr

document.getElementById('entryDate').value = currentDate;

function saveEntry() {
  const date = document.getElementById('entryDate').value;
  const sleepTime = document.getElementById('sleepTime').value;
  const wakeTime = document.getElementById('wakeTime').value;
  
  // Automatische Berechnung der Schlafdauer
  let sleepHours = null;
  if(sleepTime && wakeTime){
    const [sleepH, sleepM] = sleepTime.split(':').map(Number);
    const [wakeH, wakeM] = wakeTime.split(':').map(Number);
    let diff = (wakeH*60 + wakeM) - (sleepH*60 + sleepM);
    if(diff < 0) diff += 24*60;
    sleepHours = diff/60;
  }
  
  const entry = {
    date,
    sleepHours,
    wakeMoments: parseInt(document.getElementById('wakeMoments').value),
    alertness: parseInt(document.getElementById('alertness').value),
    energySchool: parseInt(document.getElementById('energySchool').value),
    energyHome: parseInt(document.getElementById('energyHome').value),
    sport: document.getElementById('sport').value === 'true',
    phoneBeforeSleep: parseInt(document.getElementById('phoneBeforeSleep').value),
    mealBeforeSleep: parseInt(document.getElementById('mealBeforeSleep').value),
    caffeine: document.getElementById('caffeine').value === 'true',
    alcohol: document.getElementById('alcohol').value === 'true',
    stress: document.getElementById('stress').value === 'true',
    sleepTime,
    wakeTime,
    calories: parseInt(document.getElementById('calories').value),
    weight: parseFloat(document.getElementById('weight').value)
  };

  const index = entries.findIndex(e => e.date === date);
  if(index >= 0) entries[index] = entry;
  else entries.push(entry);
  localStorage.setItem('sleepData', JSON.stringify(entries));
  alert('Eintrag gespeichert!');
  updateCharts();
}

function changeDate(offset) {
  let date = new Date(document.getElementById('entryDate').value);
  date.setDate(date.getDate() + offset);
  currentDate = date.toISOString().split('T')[0];
  document.getElementById('entryDate').value = currentDate;
  loadEntry(currentDate);
}

function loadEntry(date) {
  const entry = entries.find(e => e.date === date);
  if(entry) {
    document.getElementById('wakeMoments').value = entry.wakeMoments || '';
    document.getElementById('alertness').value = entry.alertness || '';
    document.getElementById('energySchool').value = entry.energySchool || '';
    document.getElementById('energyHome').value = entry.energyHome || '';
    document.getElementById('sport').value = entry.sport ? 'true' : 'false';
    document.getElementById('phoneBeforeSleep').value = entry.phoneBeforeSleep || '';
    document.getElementById('mealBeforeSleep').value = entry.mealBeforeSleep || '';
    document.getElementById('caffeine').value = entry.caffeine ? 'true' : 'false';
    document.getElementById('alcohol').value = entry.alcohol ? 'true' : 'false';
    document.getElementById('stress').value = entry.stress ? 'true' : 'false';
    document.getElementById('sleepTime').value = entry.sleepTime || '';
    document.getElementById('wakeTime').value = entry.wakeTime || '';
    document.getElementById('calories').value = entry.calories || '';
    document.getElementById('weight').value = entry.weight || '';
  } else {
    document.querySelectorAll('input, select').forEach(i => { if(i.type !== 'date') i.value = ''; });
  }
}

function setTimeFilter(days) {
  filterDays = days;
  updateCharts();
}

function filterEntries() {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - filterDays + 1);
  return entries.filter(e => new Date(e.date) >= cutoff).sort((a,b) => new Date(a.date) - new Date(b.date));
}

function updateCharts() {
  const filtered = filterEntries();
  const dates = filtered.map(e => e.date);

  // Schlaf & Aufwachmomente
  const sleepHoursData = filtered.map(e => e.sleepHours);
  const wakeMomentsData = filtered.map(e => e.wakeMoments);
  if(window.sleepChartInstance) window.sleepChartInstance.destroy();
  window.sleepChartInstance = new Chart(document.getElementById('sleepChart'), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        { label: 'Schlafdauer', data: sleepHoursData, borderColor: 'green', fill: false },
        { label: 'Aufwachmomente', data: wakeMomentsData, borderColor: 'red', fill: false }
      ]
    },
    options: { responsive:true, interaction:{mode:'index', intersect:false} }
  });

  // Energie-Diagramm
  const alertnessData = filtered.map(e => e.alertness);
  const energySchoolData = filtered.map(e => e.energySchool);
  const energyHomeData = filtered.map(e => e.energyHome);
  if(window.energyChartInstance) window.energyChartInstance.destroy();
  window.energyChartInstance = new Chart(document.getElementById('energyChart'), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        { label: 'Wachheit', data: alertnessData, borderColor: 'black', fill: false },
        { label: 'Energie Schule', data: energySchoolData, borderColor: 'gray', fill: false },
        { label: 'Energie Zuhause', data: energyHomeData, borderColor: 'darkgray', fill: false }
      ]
    },
    options: { responsive:true, interaction:{mode:'index', intersect:false} }
  });

  // Kalorien & Gewicht
  const caloriesData = filtered.map(e => e.calories);
  const weightData = filtered.map(e => e.weight);
  if(window.calorieWeightChartInstance) window.calorieWeightChartInstance.destroy();
  window.calorieWeightChartInstance = new Chart(document.getElementById('calorieWeightChart'), {
    type:'line',
    data: {
      labels: dates,
      datasets: [
        { label:'Kalorien', data: caloriesData, borderColor:'black', fill:false, yAxisID:'yCal' },
        { label:'Gewicht', data: weightData, borderColor:'gray', fill:false, yAxisID:'yWeight' }
      ]
    },
    options:{
      responsive:true,
      interaction:{mode:'index', intersect:false},
      scales:{
        yCal:{type:'linear', position:'left', title:{display:true,text:'Kalorien'}},
        yWeight:{type:'linear', position:'right', title:{display:true,text:'Gewicht (kg)'}}
      }
    }
  });

  // Einschlaf- & Aufstehzeit-Abweichung
  const sleepMinutes = filtered.map(e => e.sleepTime ? e.sleepTime.split(':')[0]*60 + parseInt(e.sleepTime.split(':')[1]) : null);
  const wakeMinutes = filtered.map(e => e.wakeTime ? e.wakeTime.split(':')[0]*60 + parseInt(e.wakeTime.split(':')[1]) : null);
  const avgSleep = sleepMinutes.filter(v=>v!==null).reduce((a,b)=>a+b,0)/sleepMinutes.filter(v=>v!==null).length;
  const avgWake = wakeMinutes.filter(v=>v!==null).reduce((a,b)=>a+b,0)/wakeMinutes.filter(v=>v!==null).length;
  const sleepDeviation = sleepMinutes.map(v => v!==null ? Math.abs(v-avgSleep)/60/24*100 : null);
  const wakeDeviation = wakeMinutes.map(v => v!==null ? Math.abs(v-avgWake)/60/24*100 : null);
  if(window.sleepDeviationChartInstance) window.sleepDeviationChartInstance.destroy();
  window.sleepDeviationChartInstance = new Chart(document.getElementById('sleepDeviationChart'), {
    type:'line',
    data:{
      labels:dates,
      datasets:[
        { label:'Einschlafzeit-Abweichung', data:sleepDeviation, borderColor:'black', fill:false },
        { label:'Aufstehzeit-Abweichung', data:wakeDeviation, borderColor:'gray', fill:false }
      ]
    },
    options:{responsive:true, interaction:{mode:'index', intersect:false}}
  });

  // Lifestyle-Kreisdiagramm
  const latest = filtered[filtered.length-1];
  if(latest){
    const lifestyleData = [
      latest.sport ? 1 : 0,
      (latest.phoneBeforeSleep>30) ? 1 : 0,
      (latest.mealBeforeSleep>=180) ? 1 : 0,
      latest.caffeine ? 0 : 1,
      latest.alcohol ? 0 : 1,
      latest.stress ? 0 : 1
    ];
    const colors = lifestyleData.map(v => v ? 'green' : 'red');
    if(window.lifestyleChartInstance) window.lifestyleChartInstance.destroy();
    window.lifestyleChartInstance = new Chart(document.getElementById('lifestyleChart'), {
      type:'doughnut',
      data:{
        labels:['Sport','Handy','Mahlzeit','Koffein','Alkohol','Stress'],
        datasets:[{data:lifestyleData, backgroundColor:colors}]
      },
      options:{responsive:true, plugins:{legend:{position:'bottom'}}}
    });
  }
}

loadEntry(currentDate);
updateCharts();
</script>

</body>
</html>
